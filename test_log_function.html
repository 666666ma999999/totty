<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - å ã„ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .test-button.secondary {
            background: #6c757d;
        }
        .test-button.secondary:hover {
            background: #5a6268;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .test-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .status-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .log-entry {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 8px 0;
        }
        .log-entry.chat_message {
            border-left: 4px solid #28a745;
        }
        .log-entry.user_action {
            border-left: 4px solid #17a2b8;
        }
        .log-entry.error {
            border-left: 4px solid #dc3545;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .log-type {
            font-weight: bold;
            color: #495057;
        }
        .log-timestamp {
            font-size: 11px;
            color: #6c757d;
        }
        .log-data {
            font-size: 12px;
            color: #495057;
            white-space: pre-wrap;
        }
        pre {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ãƒ­ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - å ã„ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ä¿å­˜ãƒ»ç®¡ç†æ©Ÿèƒ½ã‚’åŒ…æ‹¬çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="logCount">0</div>
                <div class="status-label">ä¿å­˜ãƒ­ã‚°æ•°</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="storageSize">0KB</div>
                <div class="status-label">ä½¿ç”¨å®¹é‡</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="sessionInfo">-</div>
                <div class="status-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</div>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="test-section">
            <h2>ğŸ“ åŸºæœ¬ãƒ­ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒ­ã‚°ã®ä¿å­˜ã€èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testBasicLogging()">åŸºæœ¬ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ</button>
                <button class="test-button secondary" onclick="viewLogs()">ãƒ­ã‚°è¡¨ç¤º</button>
                <button class="test-button danger" onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="test-output" id="basicOutput"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãƒ†ã‚¹ãƒˆ</h2>
            <p>LocalStorageã®å®¹é‡åˆ¶é™ã¨å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testStorageCapacity()">å®¹é‡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="test-button secondary" onclick="generateBulkLogs()">å¤§é‡ãƒ­ã‚°ç”Ÿæˆ</button>
            </div>
            <div class="test-output" id="storageOutput"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”— ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ã‚¹ãƒˆ</h2>
            <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®ç”Ÿæˆã€ä¿æŒã€å¾©å…ƒæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testSessionManagement()">ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ã‚¹ãƒˆ</button>
                <button class="test-button secondary" onclick="resetSession()">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="test-output" id="sessionOutput"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒ­ã‚°ã®JSONãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testDownload()">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
                <button class="test-button secondary" onclick="generateTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
            </div>
            <div class="test-output" id="downloadOutput"></div>
        </div>

        <div class="test-section">
            <h2>ğŸŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¸ã®ãƒ­ã‚°é€ä¿¡æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testBackendAPI()">APIé€£æºãƒ†ã‚¹ãƒˆ</button>
                <button class="test-button secondary" onclick="checkBackendStatus()">ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª</button>
            </div>
            <div class="test-output" id="backendOutput"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒ­ã‚°å‡¦ç†ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨åŠ¹ç‡æ€§ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
                <button class="test-button secondary" onclick="benchmarkOperations()">ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ</button>
            </div>
            <div class="test-output" id="performanceOutput"></div>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°ãƒ†ã‚¹ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹
        class LogTester {
            constructor() {
                this.sessionId = this.getSessionId();
                this.initializeStatusBar();
                this.startStatusUpdates();
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—ãƒ»ç”Ÿæˆ
            getSessionId() {
                let sessionId = localStorage.getItem('fortuneChat_sessionId');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('fortuneChat_sessionId', sessionId);
                }
                return sessionId;
            }

            // ãƒ­ã‚°ä¿å­˜
            saveLog(type, data, additionalInfo = {}) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    type,
                    data,
                    sessionId: this.sessionId,
                    ...additionalInfo
                };

                try {
                    const logs = JSON.parse(localStorage.getItem('fortuneChat_logs') || '[]');
                    logs.push(logEntry);

                    // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
                    if (logs.length > 100) {
                        logs.splice(0, logs.length - 100);
                    }

                    localStorage.setItem('fortuneChat_logs', JSON.stringify(logs));
                    this.updateStatusBar();
                    return true;
                } catch (error) {
                    console.error('ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }

            // ãƒ­ã‚°èª­ã¿è¾¼ã¿
            readLogs() {
                try {
                    return JSON.parse(localStorage.getItem('fortuneChat_logs') || '[]');
                } catch (error) {
                    console.error('ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼åˆæœŸåŒ–ãƒ»æ›´æ–°
            initializeStatusBar() {
                this.updateStatusBar();
            }

            updateStatusBar() {
                const logs = this.readLogs();
                const storageData = localStorage.getItem('fortuneChat_logs') || '';
                const sizeInBytes = new Blob([storageData]).size;

                document.getElementById('logCount').textContent = logs.length;
                document.getElementById('storageSize').textContent = this.formatBytes(sizeInBytes);
                document.getElementById('sessionInfo').textContent = this.sessionId.substring(8, 16);
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
            }

            startStatusUpdates() {
                setInterval(() => {
                    this.updateStatusBar();
                }, 2000);
            }

            // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadLogs() {
                try {
                    const logs = this.readLogs();
                    const dataStr = JSON.stringify(logs, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                    const exportFileDefaultName = `fortuneChat_logs_${new Date().toISOString().split('T')[0]}.json`;

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    return true;
                } catch (error) {
                    console.error('ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }

            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIé€ä¿¡
            async sendLogToBackend(logEntry) {
                try {
                    const response = await fetch('http://127.0.0.1:8011/api/log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(logEntry),
                        timeout: 5000
                    });

                    return {
                        success: response.ok,
                        status: response.status,
                        statusText: response.statusText
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            // ãƒ­ã‚°ã‚¯ãƒªã‚¢
            clearAllLogs() {
                localStorage.removeItem('fortuneChat_logs');
                localStorage.removeItem('fortuneChat_sessionId');
                this.sessionId = this.getSessionId();
                this.updateStatusBar();
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        const logTester = new LogTester();

        // åŸºæœ¬ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ
        function testBasicLogging() {
            const output = document.getElementById('basicOutput');
            output.innerHTML = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const testLogs = [
                {
                    type: 'chat_message',
                    data: {
                        userMessage: 'æœ€è¿‘ä»•äº‹ã§ç–²ã‚Œã¦ã„ã¾ã™...',
                        botResponse: 'ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã¨ã¦ã‚‚é ‘å¼µã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã™ã­ã€‚',
                        analysis: {
                            detectedNeeds: {
                                encouragement: 75,
                                complaining_listening: 60,
                                emotion_organizing: 30
                            },
                            emotionalAnalysis: {
                                polarity: -0.3,
                                intensity: 0.7,
                                dominant_emotion: 'ãƒã‚¬ãƒ†ã‚£ãƒ–'
                            }
                        },
                        rallyCount: 1
                    }
                },
                {
                    type: 'user_action',
                    data: {
                        action: 'send_message',
                        details: {
                            messageLength: 34,
                            inputMethod: 'keyboard'
                        }
                    }
                },
                {
                    type: 'error',
                    data: {
                        error: 'API timeout error',
                        stack: 'Error at line 425 in app.js',
                        context: 'generateResponse'
                    }
                }
            ];

            let results = [];
            let successCount = 0;

            testLogs.forEach((logData, index) => {
                const success = logTester.saveLog(
                    logData.type,
                    logData.data,
                    { testIndex: index + 1 }
                );

                if (success) successCount++;
                results.push(`${index + 1}. ${logData.type}: ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            });

            const summary = `\n=== ãƒ†ã‚¹ãƒˆçµæœ ===\næˆåŠŸ: ${successCount}/${testLogs.length}\nç·ãƒ­ã‚°æ•°: ${logTester.readLogs().length}`;
            output.innerHTML = results.join('\n') + summary;
        }

        // ãƒ­ã‚°è¡¨ç¤º
        function viewLogs() {
            const output = document.getElementById('basicOutput');

            try {
                const logs = logTester.readLogs();

                if (logs.length === 0) {
                    output.innerHTML = '<p style="color: #6c757d;">ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                const recentLogs = logs.slice(-5).reverse(); // æœ€æ–°5ä»¶ã‚’é€†é †ã§è¡¨ç¤º

                let html = `<strong>ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚° (æœ€æ–°5ä»¶ / å…¨${logs.length}ä»¶)</strong>\n\n`;

                recentLogs.forEach((log, index) => {
                    html += `<div class="log-entry ${log.type}">`;
                    html += `  <div class="log-header">`;
                    html += `    <span class="log-type">${log.type}</span>`;
                    html += `    <span class="log-timestamp">${new Date(log.timestamp).toLocaleString('ja-JP')}</span>`;
                    html += `  </div>`;
                    html += `  <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>`;
                    html += `</div>\n`;
                });

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<p style="color: #dc3545;">âŒ ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLogs() {
            if (confirm('å…¨ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                logTester.clearAllLogs();
                document.getElementById('basicOutput').innerHTML = '<p style="color: #fd7e14;">ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</p>';
            }
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãƒ†ã‚¹ãƒˆ
        function testStorageCapacity() {
            const output = document.getElementById('storageOutput');
            output.innerHTML = 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const beforeLogs = logTester.readLogs();
            const beforeSize = new Blob([localStorage.getItem('fortuneChat_logs') || '']).size;

            let results = [`é–‹å§‹æ™‚ç‚¹: ${beforeLogs.length}ä»¶ (${logTester.formatBytes(beforeSize)})`];

            // å¤§é‡ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            let testCount = 0;
            const startTime = Date.now();

            try {
                for (let i = 0; i < 25; i++) {
                    const success = logTester.saveLog('stress_test', {
                        index: i,
                        data: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿'.repeat(50),
                        timestamp: new Date().toISOString(),
                        randomData: Math.random().toString(36).repeat(10)
                    });

                    if (success) testCount++;
                }
            } catch (error) {
                results.push(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}`);
            }

            const endTime = Date.now();
            const afterLogs = logTester.readLogs();
            const afterSize = new Blob([localStorage.getItem('fortuneChat_logs') || '']).size;

            results.push(`ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ: ${testCount}ä»¶`);
            results.push(`çµ‚äº†æ™‚ç‚¹: ${afterLogs.length}ä»¶ (${logTester.formatBytes(afterSize)})`);
            results.push(`å¢—åŠ ã‚µã‚¤ã‚º: ${logTester.formatBytes(afterSize - beforeSize)}`);
            results.push(`å‡¦ç†æ™‚é–“: ${endTime - startTime}ms`);
            results.push(`1ä»¶ã‚ãŸã‚Šã®æ™‚é–“: ${((endTime - startTime) / testCount).toFixed(2)}ms`);

            output.innerHTML = results.join('\n');
        }

        // å¤§é‡ãƒ­ã‚°ç”Ÿæˆ
        function generateBulkLogs() {
            const output = document.getElementById('storageOutput');
            output.innerHTML = 'å¤§é‡ãƒ­ã‚°ç”Ÿæˆä¸­...\n';

            const logTypes = ['chat_message', 'user_action', 'error'];
            let generatedCount = 0;

            for (let i = 0; i < 50; i++) {
                const randomType = logTypes[Math.floor(Math.random() * logTypes.length)];
                const success = logTester.saveLog(randomType, {
                    bulkGeneration: true,
                    index: i,
                    randomValue: Math.random(),
                    timestamp: new Date(Date.now() - Math.random() * 86400000).toISOString()
                });

                if (success) generatedCount++;
            }

            output.innerHTML += `\nâœ… ${generatedCount}ä»¶ã®å¤§é‡ãƒ­ã‚°ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ã‚¹ãƒˆ
        function testSessionManagement() {
            const output = document.getElementById('sessionOutput');
            output.innerHTML = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const originalSession = logTester.sessionId;
            let results = [`å…ƒã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${originalSession}`];

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
            localStorage.removeItem('fortuneChat_sessionId');
            const newTester = new LogTester();
            results.push(`æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${newTester.sessionId}`);

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ
            localStorage.setItem('fortuneChat_sessionId', originalSession);
            const restoredTester = new LogTester();
            results.push(`å¾©å…ƒã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${restoredTester.sessionId}`);

            // ãƒ†ã‚¹ãƒˆçµæœ
            results.push('');
            results.push('=== æ¤œè¨¼çµæœ ===');
            results.push(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ: ${newTester.sessionId !== originalSession ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}`);
            results.push(`ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ: ${restoredTester.sessionId === originalSession ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}`);

            logTester.sessionId = originalSession; // å…ƒã«æˆ»ã™

            output.innerHTML = results.join('\n');
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
        function resetSession() {
            localStorage.removeItem('fortuneChat_sessionId');
            logTester.sessionId = logTester.getSessionId();
            logTester.updateStatusBar();
            document.getElementById('sessionOutput').innerHTML = 'ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ\næ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ' + logTester.sessionId;
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        function testDownload() {
            const output = document.getElementById('downloadOutput');

            const logs = logTester.readLogs();
            if (logs.length === 0) {
                output.innerHTML = 'âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            const success = logTester.downloadLogs();
            const results = [
                `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ: ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`,
                `ãƒ­ã‚°ä»¶æ•°: ${logs.length}ä»¶`,
                `ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${logTester.formatBytes(new Blob([JSON.stringify(logs, null, 2)]).size)}`,
                '',
                success ? 'ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ' : 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'
            ];

            output.innerHTML = results.join('\n');
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateTestData() {
            const output = document.getElementById('downloadOutput');
            output.innerHTML = 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...\n';

            const sampleData = [
                {
                    type: 'chat_message',
                    data: {
                        userMessage: 'ä»Šæ—¥ã¯æ‹æ„›ã«ã¤ã„ã¦ç›¸è«‡ãŒã‚ã‚Šã¾ã™',
                        botResponse: 'ã©ã®ã‚ˆã†ãªã“ã¨ã§ãŠæ‚©ã¿ã§ã—ã‚‡ã†ã‹ï¼Ÿ',
                        analysis: {
                            detectedNeeds: { romance: 80, emotion_organizing: 40 }
                        }
                    }
                },
                {
                    type: 'user_action',
                    data: {
                        action: 'fortune_request',
                        details: { fortuneType: 'æ‹æ„›ç›¸æ€§è¨ºæ–­' }
                    }
                }
            ];

            let count = 0;
            sampleData.forEach((data) => {
                if (logTester.saveLog(data.type, data.data)) count++;
            });

            output.innerHTML += `\nâœ… ${count}ä»¶ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`;
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãƒ†ã‚¹ãƒˆ
        async function testBackendAPI() {
            const output = document.getElementById('backendOutput');
            output.innerHTML = 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const testLog = {
                timestamp: new Date().toISOString(),
                type: 'api_test',
                data: { message: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆå®Ÿè¡Œ' },
                sessionId: logTester.sessionId
            };

            try {
                const result = await logTester.sendLogToBackend(testLog);

                const results = [
                    `é€ä¿¡çµæœ: ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`,
                    `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${result.status || 'N/A'}`,
                    `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆ: ${result.statusText || 'N/A'}`,
                    `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${result.error || 'ãªã—'}`
                ];

                output.innerHTML = results.join('\n');
            } catch (error) {
                output.innerHTML = `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª
        async function checkBackendStatus() {
            const output = document.getElementById('backendOutput');
            output.innerHTML = 'ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèªä¸­...\n';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/health', {
                    method: 'GET',
                    timeout: 3000
                });

                const results = [
                    `ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹: ${response.ok ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}`,
                    `HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status}`,
                    `å¿œç­”æ™‚é–“: ${Date.now() - Date.now()}ms` // ç°¡æ˜“æ¸¬å®š
                ];

                output.innerHTML = results.join('\n');
            } catch (error) {
                output.innerHTML = `âŒ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“: ${error.message}`;
            }
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        function testPerformance() {
            const output = document.getElementById('performanceOutput');
            output.innerHTML = 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n';

            const operations = [
                { name: 'ãƒ­ã‚°ä¿å­˜', count: 100 },
                { name: 'ãƒ­ã‚°èª­ã¿è¾¼ã¿', count: 50 },
                { name: 'JSONå¤‰æ›', count: 20 }
            ];

            let results = [];

            operations.forEach(op => {
                const startTime = performance.now();

                for (let i = 0; i < op.count; i++) {
                    if (op.name === 'ãƒ­ã‚°ä¿å­˜') {
                        logTester.saveLog('performance_test', { index: i });
                    } else if (op.name === 'ãƒ­ã‚°èª­ã¿è¾¼ã¿') {
                        logTester.readLogs();
                    } else if (op.name === 'JSONå¤‰æ›') {
                        JSON.stringify(logTester.readLogs());
                    }
                }

                const endTime = performance.now();
                const totalTime = endTime - startTime;
                const avgTime = totalTime / op.count;

                results.push(`${op.name} (${op.count}å›):`);
                results.push(`  ç·æ™‚é–“: ${totalTime.toFixed(2)}ms`);
                results.push(`  å¹³å‡æ™‚é–“: ${avgTime.toFixed(3)}ms/å›`);
                results.push('');
            });

            output.innerHTML = results.join('\n');
        }

        // ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ
        function benchmarkOperations() {
            const output = document.getElementById('performanceOutput');
            output.innerHTML = 'ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œä¸­...\n';

            const testSizes = [10, 50, 100];
            let results = ['=== ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœ ===\n'];

            testSizes.forEach(size => {
                const startTime = performance.now();

                // æŒ‡å®šã‚µã‚¤ã‚ºã®ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚’ä¸€æ°—ã«ç”Ÿæˆ
                for (let i = 0; i < size; i++) {
                    logTester.saveLog('benchmark', {
                        size: size,
                        index: i,
                        data: 'x'.repeat(100)
                    });
                }

                const endTime = performance.now();
                results.push(`${size}ä»¶å‡¦ç†: ${(endTime - startTime).toFixed(2)}ms`);
            });

            output.innerHTML = results.join('\n');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            console.log('ãƒ­ã‚°æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            console.log('ç¾åœ¨ã®ãƒ­ã‚°æ•°:', logTester.readLogs().length);
            console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:', logTester.sessionId);
        });
    </script>
</body>
</html>