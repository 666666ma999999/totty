# 占いチャットシステム - 開発設計図と各MDファイルの役割

## 🏗️ システム全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        フロントエンド                          │
│  index.html + app.js + styles.css                           │
│  ┌─────────────────┬─────────────────┬─────────────────┐      │
│  │   チャットUI      │  リアルタイム表示  │   占い結果UI     │      │
│  │   - メッセージ    │  - RESORT-TI     │  - モーダル     │      │
│  │   - 入力フォーム  │  - ニーズスコア   │  - 占い提案     │      │
│  └─────────────────┴─────────────────┴─────────────────┘      │
└─────────────────┬───────────────────────────────────────────┘
                  │ HTTP API通信
┌─────────────────┴───────────────────────────────────────────┐
│                        バックエンド                           │
│  backend/main.py (FastAPI + OpenAI GPT-4)                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              MDファイル駆動エンジン                        │ │
│  │  ┌─────────────┬──────────────┬─────────────────────┐  │ │
│  │  │ ニーズ判別   │ カテゴリ選択  │    RESORT-TI分析      │  │ │
│  │  │ システム     │ システム      │    システム           │  │ │
│  │  └─────────────┴──────────────┴─────────────────────┘  │ │
│  │  ┌─────────────┬──────────────┬─────────────────────┐  │ │
│  │  │ データ収集   │ 占いシステム  │   キャラクター設定   │  │ │
│  │  │ システム     │              │                     │  │ │
│  │  └─────────────┴──────────────┴─────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────────────────────────┘
                  │ OpenAI API連携
┌─────────────────┴───────────────────────────────────────────┐
│                      OpenAI GPT-4                          │
│          キャラクター「蒼司」の応答生成                        │
└─────────────────────────────────────────────────────────────┘
```

## 📁 プロジェクト構成と各MDファイルの役割

### 🎯 コアシステム（/systems/）

#### 1. `needs_detection.md` - ニーズ判別システム
**役割**: ユーザーの発言から5種類のニーズを自動検出
- **愚痴・傾聴ニーズ**: 「疲れた」「つらい」→共感応答
- **感情整理ニーズ**: 「混乱」「わからない」→整理支援
- **承認欲求ニーズ**: 「頑張った」「認めて」→承認・賞賛
- **励ましニーズ**: 「自信ない」「不安」→励まし・勇気づけ
- **孤独感ニーズ**: 「一人」「寂しい」→寄り添い・共感

**設定駆動要素**:
- キーワードリスト（チューニング可能）
- 重み設定（0.6-0.9）
- 検出しきい値（0.5）

#### 2. `third_sentence_categories.md` - 第3文応答カテゴリ
**役割**: 12種類の応答パターンの定義と選択基準
- **深い共感カテゴリ**: 「本当につらい状況ですね...」
- **優しい励ましカテゴリ**: 「きっと大丈夫ですよ」
- **認めと賞賛カテゴリ**: 「よく頑張られましたね」
- **寄り添いカテゴリ**: 「一人じゃありませんよ」
- **占い誘導カテゴリ**: 「星があなたにメッセージを...」（他8カテゴリ）

**設定駆動要素**:
- 応答テンプレート（追加・変更可能）
- カテゴリ別重み（0.6-1.0）
- 使用頻度制御

#### 3. `category_selection.md` - カテゴリ選択システム
**役割**: ニーズ判別結果から最適な応答カテゴリを選択
- **選択アルゴリズム**: `(ニーズ適合度×0.4) + (文脈適合度×0.3) + (重み×0.2) + (多様性×0.1)`
- **ニーズ→カテゴリマッピング**: 愚痴ニーズ→深い共感（重み1.0）
- **多様性制御**: 同一カテゴリ連続使用回避

**設定駆動要素**:
- 選択式の重み係数
- ニーズ別優先カテゴリ
- 多様性制御強度

#### 4. `analysis_system.md` - RESORT-TI分析システム
**役割**: 8次元心理分析による総合ユーザー分析
- **R** (Relationship): 人間関係 0-100
- **E** (Emotion): 感情安定性 0-100
- **S** (Spirit): 精神性・スピリチュアル 0-100
- **O** (Occupation): 職業・キャリア 0-100
- **R** (Romance): 恋愛・愛情 0-100
- **T** (Time): 時間・未来志向 0-100
- **I** (Intelligence): 知性・洞察 0-100

**占い提案タイミング**: `総合値×0.4 + データ充実度×0.3 + ニーズ明確度×0.3 ≥ 70`

#### 5. `data_collection.md` - データ収集システム
**役割**: 171項目のデータを段階的・自然に収集
- **基本情報（20項目）**: 年齢、性別、職業、交際状況等
- **心理・感情（50項目）**: 感情状態、ストレス、自信度等
- **恋愛・人間関係（50項目）**: 恋愛経験、理想像、人間関係パターン等
- **仕事・キャリア（30項目）**: 職場環境、満足度、転職願望等
- **スピリチュアル・価値観（21項目）**: 信念、占いへの関心、人生哲学等

**収集戦略**: フェーズ1(基本5-10項目)→フェーズ2(心理15-20項目)→フェーズ3(恋愛20-30項目)→フェーズ4(補完)

#### 6. `fortune_system.md` - 占いシステム
**役割**: 7種類の占いメニューとパーソナライズ実行
1. **相手の本音占い**: Romance値高→気になる相手の心理解読
2. **恋愛相性診断**: 性格・価値観の適合性分析
3. **恋愛進展タイミング**: T値重視→最適アプローチタイミング
4. **運命の相手探し**: S値高→スピリチュアル的出会い予測
5. **復縁可能性診断**: E値変動大→復縁成功確率
6. **人間関係修復**: R値低→対人関係改善指針
7. **総合運勢・人生指針**: RESORT総合値高→全人生領域

#### 7. `fortune_menu_matching.md` - 占いマッチング
**役割**: ユーザー状態と最適占いメニューの自動マッチング

### 🎭 キャラクター設定（/characters/）

#### `psychic-character.md` - イケメン霊能師「蒼司」
**役割**: AIの人格・応答スタイルの定義
- **基本設定**: 28歳、長身、神秘的雰囲気
- **性格**: 優しい包容力、深い洞察力、誠実さ
- **話し方**: 丁寧語基調、上品で穏やか
- **応答長さ**: 200-400文字目安

### 📊 データ構造（/data/）

#### `data_structure_171.md` - 171項目データ定義
**役割**: 収集するデータ項目の詳細定義

#### `greeting_system.md` - 挨拶システム
**役割**: 初回接触時の挨拶パターン

### 🎰 占いメニュー（/fortune_menus/）

#### `fortune_menu_database.md` - 占いメニューデータベース
**役割**: 利用可能な占いメニューの詳細データ

### ⚙️ 設定管理（/config/）

#### `main_config.md` - メイン設定
**役割**: システム全体の基本パラメータ

#### `api_config.md` - API設定
**役割**: OpenAI API接続設定

## 🔄 データフローと処理シーケンス

### 1. ユーザー発言処理フロー
```
ユーザー発言
    ↓
[needs_detection.md] ニーズ判別
    ↓
[category_selection.md] カテゴリ選択
    ↓
[third_sentence_categories.md] 応答パターン取得
    ↓
[psychic-character.md] キャラクター調整
    ↓
GPT-4 + システムプロンプト
    ↓
蒼司の応答生成
```

### 2. データ収集・分析フロー
```
会話継続
    ↓
[data_collection.md] 171項目データ収集
    ↓
[analysis_system.md] RESORT-TI分析
    ↓
スコア更新・占い提案判定
    ↓
[fortune_system.md] 占いメニュー選択
    ↓
パーソナライズ占い実行
```

## 🎛️ 設定駆動開発の実現

### 現在の実装状況
- ❌ **未実装**: MDファイルからの動的設定読み込み
- ❌ **未実装**: ビジネスルールの外部化
- ❌ **課題**: パラメータがコード内にハードコード

### 理想の設定駆動状態
- ✅ **MDファイル変更のみでシステム動作調整**
- ✅ **コード修正なしでの機能追加・変更**
- ✅ **リアルタイムパラメータチューニング**

## 📈 品質基準と目標値

### 応答品質
- **共感性スコア**: 20-30
- **自然性**: 80-90%
- **データ収集精度**: 85-95%
- **応答多様性**: 85-95%

### システム性能
- **API応答時間**: 2-5秒
- **占い提案精度**: 85%以上
- **ニーズ判別精度**: 80%以上

## 🔧 次のステップ

### 緊急対応事項
1. **MDファイル読み込みシステムの実装**
2. **ハードコードルールの外部化**
3. **動的パラメータ調整機能の追加**

### 中長期改善事項
1. **学習機能の実装**（ユーザーフィードバック反映）
2. **A/Bテスト機能**（応答パターン最適化）
3. **個別最適化システム**（ユーザー別カスタマイズ）

---

**この設計図により、MDファイル中心の設定駆動開発を実現し、保守性と拡張性の高い占いチャットシステムを構築します。**