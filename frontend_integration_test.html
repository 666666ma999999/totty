<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フロントエンド連携テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .test-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .test-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>🧪 フロントエンド・バックエンド連携テスト</h1>
        <p>占いチャットシステムのAPI連携とOpenAI統合機能をテストします</p>
    </div>

    <div class="test-container">
        <h2>📡 API接続テスト</h2>
        <button class="test-button" onclick="testHealthCheck()">ヘルスチェック</button>
        <button class="test-button" onclick="testChatAPI()">チャットAPI</button>
        <button class="test-button" onclick="testFortuneAPI()">占いAPI</button>
        <button class="test-button" onclick="testLogAPI()">ログAPI</button>
        <div id="apiTestResult" class="test-result info"></div>
    </div>

    <div class="test-container">
        <h2>🤖 OpenAI統合テスト</h2>
        <button class="test-button" onclick="testOpenAIChat()">OpenAI応答テスト</button>
        <button class="test-button" onclick="testCharacterConsistency()">キャラクター一貫性テスト</button>
        <button class="test-button" onclick="testAnalysisFeatures()">分析機能テスト</button>
        <div id="openaiTestResult" class="test-result info"></div>
    </div>

    <div class="test-container">
        <h2>🔄 エラーハンドリングテスト</h2>
        <button class="test-button" onclick="testInvalidRequests()">無効リクエストテスト</button>
        <button class="test-button" onclick="testNetworkErrors()">ネットワークエラーテスト</button>
        <button class="test-button" onclick="testFallbackResponses()">フォールバック応答テスト</button>
        <div id="errorTestResult" class="test-result info"></div>
    </div>

    <div class="test-container">
        <h2>📊 総合テスト結果</h2>
        <div id="overallResult" class="test-result info">
            テストを実行してください...
        </div>
    </div>

    <script>
        let testResults = {
            healthCheck: false,
            chatAPI: false,
            fortuneAPI: false,
            logAPI: false,
            openaiChat: false,
            characterConsistency: false,
            analysisFeatures: false,
            errorHandling: false
        };

        // ヘルスチェックテスト
        async function testHealthCheck() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'ヘルスチェック実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ ヘルスチェック成功\n応答: ${JSON.stringify(data, null, 2)}`;
                    testResults.healthCheck = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ ヘルスチェック失敗: ${error.message}`;
                testResults.healthCheck = false;
            }
            updateOverallResult();
        }

        // チャットAPIテスト
        async function testChatAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'チャットAPI実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'こんにちは、テストメッセージです',
                        user_data: {},
                        chat_history: [],
                        rally_count: 1
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ チャットAPI成功\n応答: "${data.response}"\nカテゴリ: ${data.category}\nスコア: ${data.fortune_timing_score}`;
                    testResults.chatAPI = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ チャットAPI失敗: ${error.message}`;
                testResults.chatAPI = false;
            }
            updateOverallResult();
        }

        // 占いAPIテスト
        async function testFortuneAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = '占いAPI実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/fortune', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fortune_type: '総合運勢・人生指針',
                        user_data: { test: true },
                        specific_context: 'テスト用の占い実行です'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ 占いAPI成功\n占い結果: "${data.fortune_result.substring(0, 200)}..."`;
                    testResults.fortuneAPI = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ 占いAPI失敗: ${error.message}`;
                testResults.fortuneAPI = false;
            }
            updateOverallResult();
        }

        // ログAPIテスト
        async function testLogAPI() {
            const resultDiv = document.getElementById('apiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'ログAPI実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        type: 'integration_test',
                        data: { message: 'フロントエンド連携テスト' },
                        sessionId: 'test_session_' + Date.now()
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ ログAPI成功\n応答: ${JSON.stringify(data, null, 2)}`;
                    testResults.logAPI = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ ログAPI失敗: ${error.message}`;
                testResults.logAPI = false;
            }
            updateOverallResult();
        }

        // OpenAI応答テスト
        async function testOpenAIChat() {
            const resultDiv = document.getElementById('openaiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'OpenAI統合テスト実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: '最近恋愛で悩んでいます。相手の気持ちがよくわからなくて不安です。',
                        user_data: {},
                        chat_history: [],
                        rally_count: 1
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const responseLength = data.response.length;
                    const hasEmpathy = data.response.includes('気持ち') || data.response.includes('不安') || data.response.includes('悩み');

                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ OpenAI応答テスト成功\n` +
                        `応答長: ${responseLength}文字\n` +
                        `共感的表現: ${hasEmpathy ? '含まれる' : '含まれない'}\n` +
                        `カテゴリ: ${data.category}\n` +
                        `応答内容: "${data.response.substring(0, 150)}..."`;
                    testResults.openaiChat = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ OpenAI応答テスト失敗: ${error.message}`;
                testResults.openaiChat = false;
            }
            updateOverallResult();
        }

        // キャラクター一貫性テスト
        async function testCharacterConsistency() {
            const resultDiv = document.getElementById('openaiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'キャラクター一貫性テスト実行中...';

            try {
                const messages = [
                    'あなたは誰ですか？',
                    '霊能力について教えてください',
                    '占いをお願いします'
                ];

                const responses = [];

                for (const message of messages) {
                    const response = await fetch('http://127.0.0.1:8011/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            user_data: {},
                            chat_history: [],
                            rally_count: 1
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        responses.push(data.response);
                    }
                }

                const hasSouji = responses.some(r => r.includes('蒼司'));
                const hasSpiritual = responses.some(r => r.includes('霊能') || r.includes('占い') || r.includes('霊視'));
                const hasPolite = responses.every(r => r.includes('です') || r.includes('ます'));

                resultDiv.className = 'test-result success';
                resultDiv.textContent = `✅ キャラクター一貫性テスト結果\n` +
                    `名前言及: ${hasSouji ? '✅' : '❌'}\n` +
                    `霊能要素: ${hasSpiritual ? '✅' : '❌'}\n` +
                    `敬語使用: ${hasPolite ? '✅' : '❌'}\n` +
                    `応答数: ${responses.length}/3`;
                testResults.characterConsistency = true;

            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ キャラクター一貫性テスト失敗: ${error.message}`;
                testResults.characterConsistency = false;
            }
            updateOverallResult();
        }

        // 分析機能テスト
        async function testAnalysisFeatures() {
            const resultDiv = document.getElementById('openaiTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = '分析機能テスト実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: '疲れた。もうだめだ。頑張ったのに認めてもらえない。寂しい。',
                        user_data: {},
                        chat_history: [],
                        rally_count: 3
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    const hasNeedsAnalysis = Object.values(data.needs_analysis || {}).some(v => v > 0);
                    const hasEmotionAnalysis = data.emotion_analysis && data.emotion_analysis.dominant_emotion;
                    const hasResortScores = data.resort_scores && Object.keys(data.resort_scores).length > 0;

                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ 分析機能テスト成功\n` +
                        `ニーズ分析: ${hasNeedsAnalysis ? '動作' : '未動作'}\n` +
                        `感情分析: ${hasEmotionAnalysis ? '動作' : '未動作'}\n` +
                        `RESORT分析: ${hasResortScores ? '動作' : '未動作'}\n` +
                        `占いタイミング: ${data.fortune_timing_score || 0}点\n` +
                        `主要感情: ${data.emotion_analysis?.dominant_emotion || 'N/A'}`;
                    testResults.analysisFeatures = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ 分析機能テスト失敗: ${error.message}`;
                testResults.analysisFeatures = false;
            }
            updateOverallResult();
        }

        // 無効リクエストテスト
        async function testInvalidRequests() {
            const resultDiv = document.getElementById('errorTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = '無効リクエストテスト実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        invalid_field: 'invalid_value'
                    })
                });

                if (response.status === 422 || response.status === 400) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ 無効リクエストテスト成功\n適切にエラーレスポンス (${response.status}) を返しました`;
                    testResults.errorHandling = true;
                } else if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `⚠️ 無効リクエストテスト部分成功\nサーバーがフォールバック処理を実行しました`;
                    testResults.errorHandling = true;
                } else {
                    throw new Error(`予期しないステータス: ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ 無効リクエストテスト失敗: ${error.message}`;
                testResults.errorHandling = false;
            }
            updateOverallResult();
        }

        // ネットワークエラーテスト（存在しないエンドポイント）
        async function testNetworkErrors() {
            const resultDiv = document.getElementById('errorTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'ネットワークエラーテスト実行中...';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/nonexistent', {
                    method: 'GET'
                });

                if (response.status === 404) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ ネットワークエラーテスト成功\n適切に404エラーを返しました`;
                    testResults.errorHandling = testResults.errorHandling && true;
                } else {
                    throw new Error(`予期しないステータス: ${response.status}`);
                }
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ ネットワークエラーテスト成功\n適切にネットワークエラーをハンドリングしました`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = `❌ ネットワークエラーテスト失敗: ${error.message}`;
                    testResults.errorHandling = false;
                }
            }
            updateOverallResult();
        }

        // フォールバック応答テスト
        async function testFallbackResponses() {
            const resultDiv = document.getElementById('errorTestResult');
            resultDiv.className = 'test-result info';
            resultDiv.textContent = 'フォールバック応答テスト実行中...';

            // 一時的にOpenAI APIを無効な設定にしてテストすることはできないため、
            // 正常な応答が返ってくることを確認
            try {
                const response = await fetch('http://127.0.0.1:8011/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'フォールバックテスト',
                        user_data: {},
                        chat_history: [],
                        rally_count: 1
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = `✅ フォールバック応答テスト成功\n` +
                        `システムが正常に応答を返しました\n` +
                        `応答: "${data.response.substring(0, 100)}..."`;
                    testResults.errorHandling = testResults.errorHandling && true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = `❌ フォールバック応答テスト失敗: ${error.message}`;
                testResults.errorHandling = false;
            }
            updateOverallResult();
        }

        // 総合結果更新
        function updateOverallResult() {
            const resultDiv = document.getElementById('overallResult');
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const successRate = (passed / total * 100).toFixed(1);

            let resultText = `📊 総合テスト結果: ${passed}/${total} 合格 (${successRate}%)\n\n`;

            // 個別結果
            const testNames = {
                healthCheck: 'ヘルスチェック',
                chatAPI: 'チャットAPI',
                fortuneAPI: '占いAPI',
                logAPI: 'ログAPI',
                openaiChat: 'OpenAI応答',
                characterConsistency: 'キャラクター一貫性',
                analysisFeatures: '分析機能',
                errorHandling: 'エラーハンドリング'
            };

            for (const [key, name] of Object.entries(testNames)) {
                const status = testResults[key] ? '✅' : '❌';
                const indicator = testResults[key] ? 'status-ok' : 'status-error';
                resultText += `${status} ${name}\n`;
            }

            // 総合評価
            resultText += '\n';
            if (successRate >= 90) {
                resultText += '🎉 総合評価: 優秀 - システムは正常に動作しています';
                resultDiv.className = 'test-result success';
            } else if (successRate >= 70) {
                resultText += '✅ 総合評価: 良好 - 一部機能に改善の余地があります';
                resultDiv.className = 'test-result success';
            } else {
                resultText += '⚠️ 総合評価: 要改善 - 重要な問題が検出されました';
                resultDiv.className = 'test-result error';
            }

            resultDiv.textContent = resultText;
        }

        // 初期化
        window.addEventListener('load', () => {
            console.log('フロントエンド連携テストページ読み込み完了');
            updateOverallResult();
        });
    </script>
</body>
</html>