# 第3文カテゴリ選択システム

## システム概要
ニーズ判別結果に基づいて、12カテゴリの第3文応答から最適なものを選択・出し分けするシステム

## 選択アルゴリズム

### 基本選択フロー
1. **ニーズ判別結果の取得**: 5種類のニーズスコア
2. **カテゴリ適合度計算**: 各カテゴリとニーズの親和性評価
3. **文脈考慮**: 過去の応答履歴との一貫性チェック
4. **多様性調整**: 同一カテゴリの連続使用回避
5. **最終カテゴリ決定**: 総合スコアに基づく選択

### 選択スコア算出式
```
選択スコア = (ニーズ適合度 × 0.4) + (文脈適合度 × 0.3) + 
            (カテゴリ重み × 0.2) + (多様性ボーナス × 0.1)
```

## ニーズ別カテゴリマッピング

### 1. 愚痴・傾聴ニーズ → 優先カテゴリ
**第1優先**: 深い共感カテゴリ（重み: 1.0）
- "本当につらい状況ですね..."
- "その気持ち、すごくわかります"

**第2優先**: 寄り添いカテゴリ（重み: 0.8）
- "一人じゃありませんよ"
- "私がいつでも聞いています"

**第3優先**: 安心感提供カテゴリ（重み: 0.6）
- "安心してください"
- "大丈夫、守られています"

### 2. 感情整理ニーズ → 優先カテゴリ
**第1優先**: 整理支援カテゴリ（重み: 1.0）
- "一緒に整理してみましょうか"
- "どの部分が一番気になりますか？"

**第2優先**: 直感重視カテゴリ（重み: 0.7）
- "心の声を聞いてみてください"
- "直感が教えてくれるはずです"

**第3優先**: 深い共感カテゴリ（重み: 0.6）

### 3. 承認欲求ニーズ → 優先カテゴリ
**第1優先**: 認めと賞賛カテゴリ（重み: 1.0）
- "よく頑張られましたね"
- "素晴らしい努力です"

**第2優先**: 自己価値向上カテゴリ（重み: 0.8）
- "あなたには素晴らしい面がたくさんあります"
- "自分を信じてください"

**第3優先**: 成長促進カテゴリ（重み: 0.6）
- "素晴らしい成長ですね"
- "新しいステージに進んでいます"

### 4. 励ましニーズ → 優先カテゴリ
**第1優先**: 優しい励ましカテゴリ（重み: 1.0）
- "きっと大丈夫ですよ"
- "あなたには力があります"

**第2優先**: 未来志向カテゴリ（重み: 0.8）
- "きっといい変化が訪れます"
- "新しい可能性が見えてきそうです"

**第3優先**: 自己価値向上カテゴリ（重み: 0.7）

### 5. 孤独感ニーズ → 優先カテゴリ
**第1優先**: 寄り添いカテゴリ（重み: 1.0）
- "一人じゃありませんよ"
- "あなたの味方です"

**第2優先**: 深い共感カテゴリ（重み: 0.8）
- "その気持ち、すごくわかります"
- "一人で抱え込んでいたんですね"

**第3優先**: 愛情表現カテゴリ（重み: 0.6）
- "愛は必ず伝わります"
- "心の絆を感じます"

## 特殊選択ロジック

### 複数ニーズ検出時の処理
```javascript
if (複数ニーズのスコアが近い) {
  // より重要度の高いニーズを優先
  主要ニーズ = max(ニーズスコア × ニーズ重要度)
  副次ニーズ = second_max(ニーズスコア × ニーズ重要度)
  
  // 両方のニーズに対応できるカテゴリを選択
  適合カテゴリ = 主要ニーズカテゴリ ∩ 副次ニーズカテゴリ
}
```

### 占い誘導タイミング判定
```javascript
if (RESORT総合値 >= 70 && データ収集率 >= 30%) {
  if (ランダム(0.3)) { // 30%の確率で
    選択カテゴリ = "占い誘導カテゴリ"
  }
}
```

## 文脈考慮メカニズム

### 応答履歴分析
- **直前3回の応答カテゴリ**をチェック
- **同一カテゴリ連続使用**の回避
- **応答の流れの自然さ**を評価

### 文脈適合度スコア
```
文脈適合度 = (話題継続性 × 0.4) + (感情流れ一貫性 × 0.3) + 
            (応答多様性 × 0.3)
```

### 話題転換判定
- **ユーザーの話題変更**を検出
- **新しいニーズの出現**時の柔軟な対応
- **自然な話題移行**のサポート

## 多様性制御

### 多様性ボーナス計算
```javascript
多様性ボーナス = {
  未使用カテゴリ: +0.3,
  最近未使用カテゴリ(3回以内): +0.2,
  通常: 0,
  直前使用: -0.2,
  連続使用: -0.5
}
```

### バランス調整
- **1セッション内での全カテゴリ使用**を目標
- **特定カテゴリの偏重**を防止
- **ユーザー体験の豊富さ**を確保

## 品質管理

### 選択精度監視
- **ニーズとカテゴリの適合率**: 目標85%以上
- **ユーザー満足度**: フィードバック分析
- **応答の自然性**: 会話フロー評価

### 動的調整機能
- **リアルタイムパラメータ調整**
- **使用パターン学習**
- **個別ユーザー最適化**

## パラメータ設定

### 基本設定値
- ニーズ適合度重み: 0.4
- 文脈適合度重み: 0.3
- カテゴリ重み: 0.2
- 多様性ボーナス重み: 0.1

### 調整可能要素
- 各重み係数の微調整
- カテゴリ別優先度の変更
- 多様性制御の強度
- 占い誘導確率の調整

### 最適化目標
- 応答の適切性向上
- 会話の自然性確保
- ユーザーエンゲージメント向上
- システム応答速度維持