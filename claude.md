# プロジェクト概要

このプロジェクトは、

- エンドユーザーのメンタルを健全にしつつ、
- エンドユーザーの最適な占いメニューを提案し
- 占いを実行する

開発です。

## Claudeの役割

あなたはシニアフルスタックエンジニアとして、クリーンで保守性の高いコードを提供してください。

## 技術スタック

- Frontend: React 18, TypeScript, Tailwind CSS
- Backend: Python, PostgreSQL

## ドキュメントスタイル

- 簡潔で明確な文章
- 専門用語は初出時に説明
- 読者は中級レベルの開発者を想定

## コーディング規約

- 関数コンポーネントとhooksを使用する
- 変数名はcamelCase、コンポーネント名はPascalCase
- 型定義は必ず行う
- コメントは日本語で記述

## 応答形式

- コードブロックには必ず言語を指定
- 新しい機能を実装する際は、まず設計の概要を説明
- エラーハンドリングを必ず含める
- コードを実行する前に変更ファイルと箇所を必ず確認してから実行する
- MDファイルは拡張・変更しやすいように機能ごとに分ける

## 設定駆動開発原則

### MDファイル優先設計（最優先）
- **チャットのチューニング可能な要素は全てMDファイルで管理する**
  - 応答パターン・テンプレート
  - 閾値・重み・パラメータ
  - カテゴリ構成・選択ロジック
  - キャラクター設定・口調
  - 占い提案条件・タイミング（RESORT-TI値ベース計算式）
  - **システムプロンプト・AI応答指示**
  - **挨拶文生成ルール**

### ルール外部化原則（必須遵守）
- **各機能のビジネスルールは極力コードに記述せず、MDファイルにまとめる**
  - ニーズ判別のキーワード・パターン
  - データ収集の優先度・戦略
  - 応答生成の重み・確率
  - 占いマッチングのアフィニティ
  - 分析システムの計算式・条件
  - **AIプロンプトテンプレート**

### 実装指針（厳格適用）
- コードは**ルールを読み込んで実行するエンジン**として設計
- MDファイル変更時は**コード修正なし**で動作変更可能
- 新機能追加時は**MDファイル追加**で拡張
- **システムプロンプトは必ずMDファイルから読み込み、コード内には記述しない**
- **動的な値（日時、ユーザー情報）のみをコードで追加**

### Claude開発指針（追加）
- **MDファイルを直接読み込む単純な実装を優先**
- **複雑な解析や変換処理を避け、MDファイルの内容をそのまま使用**
- **設定変更時はMDファイルのみ編集し、Pythonコードは触らない**
- **新しい機能追加時も既存コードの修正ではなく、MDファイル追加で対応**

## 禁止事項（厳格）

- クラスコンポーネントの使用
- anyタイプの使用（やむを得ない場合は理由を説明）
- **ハードコードされたビジネスルール**（MDファイルで管理すべき内容）
- **システムプロンプトのコード内記述**（必ずMDファイルから読み込み）
- **MDファイルの内容を複雑に解析・変換する処理**（直接読み込みを優先）

---

## プロジェクト構成

```
totty/
├── claude.md                      # 本ファイル - プロジェクト設定
├── README.md                      # プロジェクト概要
├── index.html                     # メインアプリケーション
├── styles.css                     # スタイルシート
├── app.js                        # メインロジック
├── SYSTEM_DESIGN.md              # システム設計書
├── ARCHITECTURE_DIAGRAM.md       # アーキテクチャ図
├── config/                       # 設定ファイル群
│   ├── main_config.md           # メイン設定
│   └── api_config.md            # API設定
├── systems/                     # システムファイル群
│   ├── needs_detection.md       # ニーズ判別システム
│   ├── third_sentence_categories.md # 第3文カテゴリ定義
│   ├── data_collection.md       # データ収集システム
│   ├── analysis_system.md       # 分析システム（RESORT-TI）
│   ├── fortune_system.md        # 占いシステム
│   ├── fortune_menu_matching.md # 占いメニューマッチング
│   └── category_selection.md    # 第3文カテゴリ選択システム
├── characters/                  # キャラクターファイル群
│   ├── psychic-character.md     # イケメン霊能師
│   └── osaka-obachan-character.md # 大阪のおばちゃん
├── data/                        # データファイル群
│   ├── data_structure_171.md    # データ構造定義（171項目）
│   └── greeting_system.md       # 挨拶システム
├── fortune_menus/               # 占いメニュー群
│   └── fortune_menu_database.md # 占いメニューデータベース
└── origin/                      # 元仕様書群
    ├── phase2_main_v364_updated.md
    └── fortune_chatbot_claude_code.md
```

## システム機能概要

### 1. メンタルケア機能
- **ニーズ判別システム**: ユーザーの5種類のニーズを自動検出
  - 愚痴・傾聴、感情整理、承認欲求、励まし、孤独感
- **第3文カテゴリ応答**: 12種類の共感的応答パターン
- **リアルタイム分析**: RESORT-TI 8次元心理分析

### 2. 占いメニュー提案機能
- **データ収集システム**: 171項目の段階的データ収集
- **RESORT-TI提案タイミング**: 8次元心理分析による動的スコア計算
- **マッチングアルゴリズム**: ニーズ親和性に基づく最適メニュー選択

### 3. 占い実行機能
- **7種類の占いメニュー**: 相手の本音、相性診断、恋愛進展等
- **動的メニュー選択**: ユーザーの心理状態に応じた最適化
- **インタラクティブUI**: クリック可能な占い提案

## 開発ガイドライン

### MDファイル管理
- 各MDファイルは独立した機能を持つモジュールとして設計
- 設定変更時はMDファイルを編集するだけで動作を調整可能
- 新機能追加時は対応するMDファイルを作成

### 品質基準
- **共感性**: 20-30の共感スコア維持
- **自然性**: 80-90%の自然な会話
- **正確性**: 85-95%のデータ収集精度
- **応答多様性**: 85-95%の応答バリエーション

### セキュリティ
- 個人情報の適切な取り扱い
- セッション管理の安全性確保
- プライバシー配慮の実装

## ポート設定管理原則（重要）

### 設定変更禁止ルール
- **既存のポート設定は絶対に変更しない**
- **新機能追加時は現在の設定値を必ず確認・継承**
- **環境変数またはMDファイルから設定を読み込む**

### 設定継承の手順
1. **事前確認**: `backend/shared/config.py` の現在のPORT値を確認
2. **設定読み込み**: 環境変数 `APP_PORT` または設定ファイルから動的に取得
3. **CORS設定**: ポート番号は動的に生成（`http://localhost:{port}`形式）
4. **フロントエンド**: APIベースURLは設定から動的取得

### 実装パターン（推奨）
```python
# ❌ 禁止: ハードコード
PORT = 8011

# ✅ 推奨: 環境変数優先
PORT = int(os.getenv("APP_PORT", "8011"))

# ✅ 推奨: MDファイル読み込み
PORT = load_config_from_md()["server"]["port"]
```

### チェック項目
- [ ] 新機能実装前に現在のポート設定を確認
- [ ] ポート番号をハードコードしていない
- [ ] CORS設定でポート番号を動的生成
- [ ] 環境変数またはMDファイルから設定読み込み

---

*このファイルは開発チームの指針として機能し、プロジェクトの一貫性とクオリティを保証します。*