# 占いチャットシステム - 蒼司の占い館

## システム概要

本システムは、v3.2仕様に基づく恋愛相談特化型の占いチャットボットです。ユーザーのメンタルを健全に保ちながら、心理分析と占い提案を通じて最適なサポートを提供します。

### 主要機能
- **ニーズ判別システム**: 5種類のユーザーニーズ自動検出
- **RESORT 6次元分析**: 心理状態の多角的評価
- **データ収集システム**: 171項目の段階的情報収集
- **占いメニュー提案**: 7種類の占いメニューから最適選択
- **自然な会話**: 心の専門家パートナー「蒼司」による共感的対話

## 技術スタック

### フロントエンド
- **HTML5/CSS3**: リスポンシブWebインターフェース
- **JavaScript (Vanilla)**: リアルタイム分析表示とインタラクション
- **WebSocket**: リアルタイム通信

### バックエンド
- **Python 3.9+**: FastAPIフレームワーク
- **Claude Sonnet API**: 高度感情分析
- **OpenAI GPT-4**: 自然言語処理
- **YAML/Markdown**: 設定駆動型アーキテクチャ

## アーキテクチャ

### システム構成
```
totty2/
├── index.html                     # メインアプリケーション
├── styles.css                     # スタイル定義
├── app.js                         # フロントエンドロジック
├── backend/                       # Pythonバックエンド
│   ├── main.py                   # FastAPIメインサーバー
│   ├── services/                 # ビジネスロジック
│   │   ├── chat_service.py      # チャット・分析サービス
│   │   └── analysis_service.py  # 分析エンジン
│   └── shared/                   # 共通設定
│       └── config.py            # アプリケーション設定
├── systems/                      # システム定義（MD）
│   ├── needs_detection.md       # ニーズ判別システム
│   ├── resort_v32_analysis.md   # RESORT 6次元分析
│   ├── data_collection.md       # データ収集システム
│   ├── third_sentence_categories.md # 応答カテゴリ
│   ├── fortune_system.md        # 占いシステム
│   └── fortune_menu_matching.md # 占いマッチング
├── characters/                   # キャラクター設定
│   └── psychic-character.md     # 蒼司キャラクター定義
└── data/                        # データファイル
    ├── greeting_core.md         # 挨拶システム
    └── seasonal_expressions.md  # 季節表現
```

## 核心システム仕様

### 1. ニーズ判別システム

#### 検出対象（5カテゴリ）
1. **愚痴・傾聴ニーズ** (重み: 0.8)
   - キーワード: "疲れた", "うんざり", "聞いて", "つらい"
   - 応答: 共感・傾聴型

2. **感情整理ニーズ** (重み: 0.7)
   - キーワード: "混乱", "わからない", "整理", "迷っている"
   - 応答: 整理支援・問いかけ型

3. **承認欲求ニーズ** (重み: 0.6)
   - キーワード: "認めて", "頑張った", "評価", "誉めて"
   - 応答: 承認・賞賛型

4. **励ましニーズ** (重み: 0.9)
   - キーワード: "落ち込む", "自信ない", "不安", "心配"
   - 応答: 励まし・勇気づけ型

5. **孤独感ニーズ** (重み: 0.8)
   - キーワード: "一人", "寂しい", "孤独", "理解者がいない"
   - 応答: 寄り添い・共感型

#### 判定式
```
ニーズスコア = (キーワード重み × 出現回数) + 感情スコア + 文脈スコア
最終判定 = max(ニーズスコア) > 閾値(0.5)
```

### 2. RESORT 6次元分析システム（v3.2仕様）

#### 分析次元
1. **R - Relationship（関係性の深さ・親密度）** (1-10)
   - 高親密度: ["彼氏", "彼女", "恋人"] → score: 7
   - 中親密度: ["友人", "職場", "家族"] → score: 5
   - デフォルト: max(1, rally_count)

2. **E - Emotion（感情の強度・種類）** (1-10)
   - 強感情: ["不安", "心配", "寂しい", "辛い", "悲しい"] → min(8, 5 + emotion_count)
   - 特別パターン: ["連絡", "ない"] → score: 7
   - デフォルト: max(1, int(sum(needs_analysis.values()) * 5))

3. **S - Situation（状況の緊急度・深刻度）** (1-10)
   - 緊急: ["緊急", "今すぐ", "どうしよう", "大変"] → score: 8
   - 連絡状況: ["連絡", "ない"] → score: 5
   - デフォルト: max(1, min(7, rally_count + 2))

4. **O - Objective（相談者の目的の明確さ）** (1-10)
   - 明確目的: ["どうしたら", "方法", "解決"] → score: 6
   - デフォルト: score: 3

5. **R - Resource（相談者の心理的リソース）** (1-10)
   - ポジティブ: ["頑張る", "できる", "強い", "大丈夫"] → +1
   - ネガティブ: ["疲れた", "無理", "限界", "もうダメ"] → -1
   - ネガティブ優勢: 3, デフォルト: 5

6. **T - Time（時間的要因・タイミング）** (1-10)
   - 時間要因: ["最近", "今", "以前から", "長い間"] → score: 8
   - 連絡時間: ["連絡"] → score: 8
   - デフォルト: max(1, rally_count)

#### 総合スコア算出
```
総合値 = (R + E + S + O + Resource + T) / 6
正規化: min(10, max(1, calculated_score))
```

#### 占い提案タイミング算出
```yaml
timing_calculation:
  resort_weight: 0.4
  needs_weight: 0.6
  formula: |
    total_resort = sum(resort_scores) / 6
    needs_strength = sum(needs_analysis.values()) * 10
    timing_score = int(total_resort * 0.4 + needs_strength * 0.6)
    return min(100, max(0, timing_score))
```

### 3. データ収集システム（171項目）

#### 項目分類
- **基本情報**: 20項目（年齢、性別、職業、居住地域等）
- **心理・感情**: 50項目（感情状態、不安レベル、自信度等）
- **恋愛・人間関係**: 50項目（恋愛経験、理想のパートナー像等）
- **仕事・キャリア**: 30項目（職場環境、キャリア満足度等）
- **スピリチュアル・価値観**: 21項目（信念体系、占いへの関心等）

#### 収集戦略
- **フェーズ1**（ラリー1-3）: 基本情報5-10項目
- **フェーズ2**（ラリー4-8）: 心理・感情データ15-20項目
- **フェーズ3**（ラリー9-15）: 恋愛・人間関係20-30項目
- **フェーズ4**（継続）: 残り項目の補完収集

#### 収集制御
- 1回のやり取りで最大3項目まで
- 連続した直接質問の回避
- 自然な流れでの情報収集

### 4. 第3文カテゴリシステム（12カテゴリ）

#### 応答カテゴリ
1. **深い共感カテゴリ** (重み: 0.9) - 愚痴・傾聴時
2. **優しい励ましカテゴリ** (重み: 0.8) - 励まし時
3. **認めと賞賛カテゴリ** (重み: 0.7) - 承認欲求時
4. **寄り添いカテゴリ** (重み: 0.8) - 孤独感時
5. **整理支援カテゴリ** (重み: 0.6) - 感情整理時
6. **未来志向カテゴリ** (重み: 0.7) - 不安・心配時
7. **自己価値向上カテゴリ** (重み: 0.8) - 自信喪失時
8. **安心感提供カテゴリ** (重み: 0.8) - 不安・恐怖時
9. **愛情表現カテゴリ** (重み: 0.7) - 恋愛相談時
10. **成長促進カテゴリ** (重み: 0.6) - 向上心時
11. **直感重視カテゴリ** (重み: 0.7) - 迷い・判断時
12. **占い誘導カテゴリ** (重み: 1.0) - RESORT総合値70以上時

#### 選択式
```
カテゴリスコア = ニーズ適合度 × 重み × 文脈適合度 × 頻度調整値
最終選択 = argmax(カテゴリスコア)
```

### 5. 占いシステム（7種類メニュー）

#### 占いメニュー構成
1. **相手の本音占い** - Romance値高、人間関係の悩み
2. **恋愛相性診断** - 恋愛関心高、パートナーシップ重視
3. **恋愛進展タイミング** - 恋愛積極性、タイミング重視
4. **運命の相手探し** - S値高、運命的出会い志向
5. **復縁可能性診断** - 過去恋愛執着、E値変動大
6. **人間関係修復** - R値低、対人関係の悩み深刻
7. **総合運勢・人生指針** - RESORT総合値高、人生全般関心

#### マッチングアルゴリズム
```
マッチングスコア = (ニーズ親和性 × 0.3) + (RESORT適合度 × 0.4) +
                  (データ充実度 × 0.2) + (状況適合性 × 0.1)
```

#### 占いメニューマッピング
```yaml
fortune_mapping:
  relationship: "相手の本音占い"        # 関係性が高い場合
  emotion: "恋愛進展タイミング"          # 感情が高い場合
  situation: "人間関係修復"             # 状況が深刻な場合
  objective: "恋愛相性診断"             # 目的が明確な場合
  resource: "復縁可能性診断"            # 心理リソース低い場合
  time: "運命の相手探し"               # 時間要因が高い場合
  default: "総合運勢・人生指針"         # デフォルト・バランス型
```

## キャラクター設定

### 蒼司（そうじ）- 心の専門家パートナー
- **役割**: 豊富な経験と深い心理理解を持つ専門家でありながら、相談者と同じ目線で対話するパートナー
- **対象**: 20-40歳の女性
- **応答制約**: 3センテンス以内、150-250文字程度
- **専門性**: 1万人以上の相談経験、心理と感情の専門的理解、占い鑑定の専門知識

## 感情分析システム

### Claude Sonnet APIベース分析
```python
def analyze_emotion_advanced(message: str) -> Dict[str, Any]:
    """Claude Sonnet APIベース高度感情分析（v3.2仕様）"""
    # APIを使用した高度感情分析
    # フォールバック機能付き
```

### 出力形式
```json
{
  "emotion_intensity": 70,        # 0-100スケール
  "primary_emotion": "不安",      # 主要感情
  "empathy_level": 4,            # 1-5スケール
  "analysis_quality": "高品質"    # 品質評価
}
```

## 品質基準

### パフォーマンス指標
- **共感性**: 20-30の共感スコア維持
- **自然性**: 80-90%の自然な会話
- **正確性**: 85-95%のデータ収集精度
- **応答多様性**: 85-95%の応答バリエーション

### 倫理的配慮
- 過度な不安を与えない表現
- 希望的な要素を含む結果
- 自己決定の重要性強調
- 占いは参考程度であることの明示

## 設定駆動開発

### MDファイル優先設計
- チャットのチューニング可能要素は全てMDファイルで管理
- 応答パターン・テンプレート
- 閾値・重み・パラメータ
- カテゴリ構成・選択ロジック
- システムプロンプト・AI応答指示

### ルール外部化原則
- ビジネスルールは極力コードに記述せず、MDファイルにまとめる
- MDファイル変更時はコード修正なしで動作変更可能
- 新機能追加時はMDファイル追加で拡張

## セットアップ・運用

### 環境設定
```bash
# 必要な環境変数
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_claude_api_key
DEBUG=false
APP_PORT=8011
```

### サーバー起動
```bash
# バックエンド起動
cd backend
python3 main.py

# フロントエンド
# index.htmlをブラウザで開く
# または http://localhost:8011 でアクセス
```

### 設定調整
各種設定は対応するMDファイルを編集することで調整可能：
- `systems/needs_detection.md` - ニーズ判別ルール
- `systems/resort_v32_analysis.md` - RESORT分析ルール
- `systems/third_sentence_categories.md` - 応答カテゴリ
- `characters/psychic-character.md` - キャラクター設定

## ログ・監視

### リアルタイム分析表示
- ラリー回数カウント
- 心理的リソース値（I値）
- データ収集進捗（基本情報、心理・感情、恋愛関係等）
- 検出ニーズ（愚痴・傾聴、感情整理、承認欲求、励まし、孤独感）
- RESORT 6次元分析値と詳細分析
- 感情分析値（主要感情、強度、共感レベル）
- 多層感情解析（表層、中層、深層）
- 占い提案スコア

### ログ管理
- チャットログの自動保存
- セッションベースの履歴管理
- ログダウンロード・クリア機能

## バージョン情報

- **システムバージョン**: v3.2準拠
- **RESORT分析**: 6次元システム
- **対応占いメニュー**: 7種類
- **データ収集項目**: 171項目
- **応答カテゴリ**: 12種類
- **感情分析**: Claude Sonnet API + フォールバック

---

*このシステムは設定駆動開発原則に基づき、MDファイルによる柔軟な設定変更と拡張が可能です。*