<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログ機能テスト - 占いチャットシステム</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .test-button.secondary {
            background: #6c757d;
        }
        .test-button.secondary:hover {
            background: #5a6268;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .test-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .status-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .log-entry {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 8px 0;
        }
        .log-entry.chat_message {
            border-left: 4px solid #28a745;
        }
        .log-entry.user_action {
            border-left: 4px solid #17a2b8;
        }
        .log-entry.error {
            border-left: 4px solid #dc3545;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .log-type {
            font-weight: bold;
            color: #495057;
        }
        .log-timestamp {
            font-size: 11px;
            color: #6c757d;
        }
        .log-data {
            font-size: 12px;
            color: #495057;
            white-space: pre-wrap;
        }
        pre {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 ログ機能テスト - 占いチャットシステム</h1>
            <p>フロントエンドのログ保存・管理機能を包括的にテストします</p>
        </div>

        <!-- ステータスバー -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="logCount">0</div>
                <div class="status-label">保存ログ数</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="storageSize">0KB</div>
                <div class="status-label">使用容量</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="sessionInfo">-</div>
                <div class="status-label">セッションID</div>
            </div>
        </div>

        <!-- テストセクション -->
        <div class="test-section">
            <h2>📝 基本ログ機能テスト</h2>
            <p>ログの保存、読み込み、表示機能をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testBasicLogging()">基本ログテスト</button>
                <button class="test-button secondary" onclick="viewLogs()">ログ表示</button>
                <button class="test-button danger" onclick="clearLogs()">ログクリア</button>
            </div>
            <div class="test-output" id="basicOutput"></div>
        </div>

        <div class="test-section">
            <h2>💾 ストレージ容量テスト</h2>
            <p>LocalStorageの容量制限と大量データの処理をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testStorageCapacity()">容量テスト実行</button>
                <button class="test-button secondary" onclick="generateBulkLogs()">大量ログ生成</button>
            </div>
            <div class="test-output" id="storageOutput"></div>
        </div>

        <div class="test-section">
            <h2>🔗 セッション管理テスト</h2>
            <p>セッションIDの生成、保持、復元機能をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testSessionManagement()">セッション管理テスト</button>
                <button class="test-button secondary" onclick="resetSession()">セッションリセット</button>
            </div>
            <div class="test-output" id="sessionOutput"></div>
        </div>

        <div class="test-section">
            <h2>📥 ダウンロード機能テスト</h2>
            <p>ログのJSONファイル出力機能をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testDownload()">ダウンロードテスト</button>
                <button class="test-button secondary" onclick="generateTestData()">テストデータ生成</button>
            </div>
            <div class="test-output" id="downloadOutput"></div>
        </div>

        <div class="test-section">
            <h2>🌐 バックエンド連携テスト</h2>
            <p>バックエンドAPIへのログ送信機能をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testBackendAPI()">API連携テスト</button>
                <button class="test-button secondary" onclick="checkBackendStatus()">サーバー状態確認</button>
            </div>
            <div class="test-output" id="backendOutput"></div>
        </div>

        <div class="test-section">
            <h2>🎯 パフォーマンステスト</h2>
            <p>ログ処理のパフォーマンスと効率性をテストします。</p>
            <div class="test-buttons">
                <button class="test-button" onclick="testPerformance()">パフォーマンステスト</button>
                <button class="test-button secondary" onclick="benchmarkOperations()">ベンチマーク実行</button>
            </div>
            <div class="test-output" id="performanceOutput"></div>
        </div>
    </div>

    <script>
        // ログテスタークラス
        class LogTester {
            constructor() {
                this.sessionId = this.getSessionId();
                this.initializeStatusBar();
                this.startStatusUpdates();
            }

            // セッションID取得・生成
            getSessionId() {
                let sessionId = localStorage.getItem('fortuneChat_sessionId');
                if (!sessionId) {
                    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('fortuneChat_sessionId', sessionId);
                }
                return sessionId;
            }

            // ログ保存
            saveLog(type, data, additionalInfo = {}) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    type,
                    data,
                    sessionId: this.sessionId,
                    ...additionalInfo
                };

                try {
                    const logs = JSON.parse(localStorage.getItem('fortuneChat_logs') || '[]');
                    logs.push(logEntry);

                    // 最新100件のみ保持
                    if (logs.length > 100) {
                        logs.splice(0, logs.length - 100);
                    }

                    localStorage.setItem('fortuneChat_logs', JSON.stringify(logs));
                    this.updateStatusBar();
                    return true;
                } catch (error) {
                    console.error('ログ保存エラー:', error);
                    return false;
                }
            }

            // ログ読み込み
            readLogs() {
                try {
                    return JSON.parse(localStorage.getItem('fortuneChat_logs') || '[]');
                } catch (error) {
                    console.error('ログ読み込みエラー:', error);
                    return [];
                }
            }

            // ステータスバー初期化・更新
            initializeStatusBar() {
                this.updateStatusBar();
            }

            updateStatusBar() {
                const logs = this.readLogs();
                const storageData = localStorage.getItem('fortuneChat_logs') || '';
                const sizeInBytes = new Blob([storageData]).size;

                document.getElementById('logCount').textContent = logs.length;
                document.getElementById('storageSize').textContent = this.formatBytes(sizeInBytes);
                document.getElementById('sessionInfo').textContent = this.sessionId.substring(8, 16);
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
            }

            startStatusUpdates() {
                setInterval(() => {
                    this.updateStatusBar();
                }, 2000);
            }

            // ログダウンロード
            downloadLogs() {
                try {
                    const logs = this.readLogs();
                    const dataStr = JSON.stringify(logs, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

                    const exportFileDefaultName = `fortuneChat_logs_${new Date().toISOString().split('T')[0]}.json`;

                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    return true;
                } catch (error) {
                    console.error('ログダウンロードエラー:', error);
                    return false;
                }
            }

            // バックエンドAPI送信
            async sendLogToBackend(logEntry) {
                try {
                    const response = await fetch('http://127.0.0.1:8011/api/log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(logEntry),
                        timeout: 5000
                    });

                    return {
                        success: response.ok,
                        status: response.status,
                        statusText: response.statusText
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            // ログクリア
            clearAllLogs() {
                localStorage.removeItem('fortuneChat_logs');
                localStorage.removeItem('fortuneChat_sessionId');
                this.sessionId = this.getSessionId();
                this.updateStatusBar();
            }
        }

        // グローバルインスタンス
        const logTester = new LogTester();

        // 基本ログテスト
        function testBasicLogging() {
            const output = document.getElementById('basicOutput');
            output.innerHTML = 'テスト実行中...\n\n';

            const testLogs = [
                {
                    type: 'chat_message',
                    data: {
                        userMessage: '最近仕事で疲れています...',
                        botResponse: 'お疲れ様です。とても頑張られているのですね。',
                        analysis: {
                            detectedNeeds: {
                                encouragement: 75,
                                complaining_listening: 60,
                                emotion_organizing: 30
                            },
                            emotionalAnalysis: {
                                polarity: -0.3,
                                intensity: 0.7,
                                dominant_emotion: 'ネガティブ'
                            }
                        },
                        rallyCount: 1
                    }
                },
                {
                    type: 'user_action',
                    data: {
                        action: 'send_message',
                        details: {
                            messageLength: 34,
                            inputMethod: 'keyboard'
                        }
                    }
                },
                {
                    type: 'error',
                    data: {
                        error: 'API timeout error',
                        stack: 'Error at line 425 in app.js',
                        context: 'generateResponse'
                    }
                }
            ];

            let results = [];
            let successCount = 0;

            testLogs.forEach((logData, index) => {
                const success = logTester.saveLog(
                    logData.type,
                    logData.data,
                    { testIndex: index + 1 }
                );

                if (success) successCount++;
                results.push(`${index + 1}. ${logData.type}: ${success ? '✅ 成功' : '❌ 失敗'}`);
            });

            const summary = `\n=== テスト結果 ===\n成功: ${successCount}/${testLogs.length}\n総ログ数: ${logTester.readLogs().length}`;
            output.innerHTML = results.join('\n') + summary;
        }

        // ログ表示
        function viewLogs() {
            const output = document.getElementById('basicOutput');

            try {
                const logs = logTester.readLogs();

                if (logs.length === 0) {
                    output.innerHTML = '<p style="color: #6c757d;">ログが見つかりません</p>';
                    return;
                }

                const recentLogs = logs.slice(-5).reverse(); // 最新5件を逆順で表示

                let html = `<strong>保存されたログ (最新5件 / 全${logs.length}件)</strong>\n\n`;

                recentLogs.forEach((log, index) => {
                    html += `<div class="log-entry ${log.type}">`;
                    html += `  <div class="log-header">`;
                    html += `    <span class="log-type">${log.type}</span>`;
                    html += `    <span class="log-timestamp">${new Date(log.timestamp).toLocaleString('ja-JP')}</span>`;
                    html += `  </div>`;
                    html += `  <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>`;
                    html += `</div>\n`;
                });

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<p style="color: #dc3545;">❌ ログ読み込みエラー: ${error.message}</p>`;
            }
        }

        // ログクリア
        function clearLogs() {
            if (confirm('全てのログを削除しますか？この操作は取り消せません。')) {
                logTester.clearAllLogs();
                document.getElementById('basicOutput').innerHTML = '<p style="color: #fd7e14;">🗑️ ログをクリアしました</p>';
            }
        }

        // ストレージ容量テスト
        function testStorageCapacity() {
            const output = document.getElementById('storageOutput');
            output.innerHTML = 'ストレージ容量テスト実行中...\n\n';

            const beforeLogs = logTester.readLogs();
            const beforeSize = new Blob([localStorage.getItem('fortuneChat_logs') || '']).size;

            let results = [`開始時点: ${beforeLogs.length}件 (${logTester.formatBytes(beforeSize)})`];

            // 大量のテストデータ生成
            let testCount = 0;
            const startTime = Date.now();

            try {
                for (let i = 0; i < 25; i++) {
                    const success = logTester.saveLog('stress_test', {
                        index: i,
                        data: 'テストデータ'.repeat(50),
                        timestamp: new Date().toISOString(),
                        randomData: Math.random().toString(36).repeat(10)
                    });

                    if (success) testCount++;
                }
            } catch (error) {
                results.push(`❌ エラー発生: ${error.message}`);
            }

            const endTime = Date.now();
            const afterLogs = logTester.readLogs();
            const afterSize = new Blob([localStorage.getItem('fortuneChat_logs') || '']).size;

            results.push(`テストデータ生成: ${testCount}件`);
            results.push(`終了時点: ${afterLogs.length}件 (${logTester.formatBytes(afterSize)})`);
            results.push(`増加サイズ: ${logTester.formatBytes(afterSize - beforeSize)}`);
            results.push(`処理時間: ${endTime - startTime}ms`);
            results.push(`1件あたりの時間: ${((endTime - startTime) / testCount).toFixed(2)}ms`);

            output.innerHTML = results.join('\n');
        }

        // 大量ログ生成
        function generateBulkLogs() {
            const output = document.getElementById('storageOutput');
            output.innerHTML = '大量ログ生成中...\n';

            const logTypes = ['chat_message', 'user_action', 'error'];
            let generatedCount = 0;

            for (let i = 0; i < 50; i++) {
                const randomType = logTypes[Math.floor(Math.random() * logTypes.length)];
                const success = logTester.saveLog(randomType, {
                    bulkGeneration: true,
                    index: i,
                    randomValue: Math.random(),
                    timestamp: new Date(Date.now() - Math.random() * 86400000).toISOString()
                });

                if (success) generatedCount++;
            }

            output.innerHTML += `\n✅ ${generatedCount}件の大量ログを生成しました`;
        }

        // セッション管理テスト
        function testSessionManagement() {
            const output = document.getElementById('sessionOutput');
            output.innerHTML = 'セッション管理テスト実行中...\n\n';

            const originalSession = logTester.sessionId;
            let results = [`元のセッションID: ${originalSession}`];

            // セッションリセット
            localStorage.removeItem('fortuneChat_sessionId');
            const newTester = new LogTester();
            results.push(`新しいセッションID: ${newTester.sessionId}`);

            // セッション復元
            localStorage.setItem('fortuneChat_sessionId', originalSession);
            const restoredTester = new LogTester();
            results.push(`復元されたセッションID: ${restoredTester.sessionId}`);

            // テスト結果
            results.push('');
            results.push('=== 検証結果 ===');
            results.push(`セッション生成: ${newTester.sessionId !== originalSession ? '✅ 正常' : '❌ 異常'}`);
            results.push(`セッション復元: ${restoredTester.sessionId === originalSession ? '✅ 正常' : '❌ 異常'}`);

            logTester.sessionId = originalSession; // 元に戻す

            output.innerHTML = results.join('\n');
        }

        // セッションリセット
        function resetSession() {
            localStorage.removeItem('fortuneChat_sessionId');
            logTester.sessionId = logTester.getSessionId();
            logTester.updateStatusBar();
            document.getElementById('sessionOutput').innerHTML = '🔄 セッションをリセットしました\n新しいセッションID: ' + logTester.sessionId;
        }

        // ダウンロードテスト
        function testDownload() {
            const output = document.getElementById('downloadOutput');

            const logs = logTester.readLogs();
            if (logs.length === 0) {
                output.innerHTML = '❌ ダウンロード可能なログがありません。まずテストデータを生成してください。';
                return;
            }

            const success = logTester.downloadLogs();
            const results = [
                `ダウンロード実行: ${success ? '✅ 成功' : '❌ 失敗'}`,
                `ログ件数: ${logs.length}件`,
                `ファイルサイズ: ${logTester.formatBytes(new Blob([JSON.stringify(logs, null, 2)]).size)}`,
                '',
                success ? '📥 ファイルのダウンロードが開始されました' : 'ダウンロードに失敗しました'
            ];

            output.innerHTML = results.join('\n');
        }

        // テストデータ生成
        function generateTestData() {
            const output = document.getElementById('downloadOutput');
            output.innerHTML = 'テストデータ生成中...\n';

            const sampleData = [
                {
                    type: 'chat_message',
                    data: {
                        userMessage: '今日は恋愛について相談があります',
                        botResponse: 'どのようなことでお悩みでしょうか？',
                        analysis: {
                            detectedNeeds: { romance: 80, emotion_organizing: 40 }
                        }
                    }
                },
                {
                    type: 'user_action',
                    data: {
                        action: 'fortune_request',
                        details: { fortuneType: '恋愛相性診断' }
                    }
                }
            ];

            let count = 0;
            sampleData.forEach((data) => {
                if (logTester.saveLog(data.type, data.data)) count++;
            });

            output.innerHTML += `\n✅ ${count}件のテストデータを生成しました`;
        }

        // バックエンドAPIテスト
        async function testBackendAPI() {
            const output = document.getElementById('backendOutput');
            output.innerHTML = 'バックエンド連携テスト実行中...\n\n';

            const testLog = {
                timestamp: new Date().toISOString(),
                type: 'api_test',
                data: { message: 'バックエンド連携テスト実行' },
                sessionId: logTester.sessionId
            };

            try {
                const result = await logTester.sendLogToBackend(testLog);

                const results = [
                    `送信結果: ${result.success ? '✅ 成功' : '❌ 失敗'}`,
                    `HTTPステータス: ${result.status || 'N/A'}`,
                    `ステータステキスト: ${result.statusText || 'N/A'}`,
                    `エラー詳細: ${result.error || 'なし'}`
                ];

                output.innerHTML = results.join('\n');
            } catch (error) {
                output.innerHTML = `❌ 接続エラー: ${error.message}`;
            }
        }

        // バックエンドサーバー状態確認
        async function checkBackendStatus() {
            const output = document.getElementById('backendOutput');
            output.innerHTML = 'サーバー状態確認中...\n';

            try {
                const response = await fetch('http://127.0.0.1:8011/api/health', {
                    method: 'GET',
                    timeout: 3000
                });

                const results = [
                    `サーバー状態: ${response.ok ? '✅ 正常' : '❌ 異常'}`,
                    `HTTPステータス: ${response.status}`,
                    `応答時間: ${Date.now() - Date.now()}ms` // 簡易測定
                ];

                output.innerHTML = results.join('\n');
            } catch (error) {
                output.innerHTML = `❌ サーバーに接続できません: ${error.message}`;
            }
        }

        // パフォーマンステスト
        function testPerformance() {
            const output = document.getElementById('performanceOutput');
            output.innerHTML = 'パフォーマンステスト実行中...\n\n';

            const operations = [
                { name: 'ログ保存', count: 100 },
                { name: 'ログ読み込み', count: 50 },
                { name: 'JSON変換', count: 20 }
            ];

            let results = [];

            operations.forEach(op => {
                const startTime = performance.now();

                for (let i = 0; i < op.count; i++) {
                    if (op.name === 'ログ保存') {
                        logTester.saveLog('performance_test', { index: i });
                    } else if (op.name === 'ログ読み込み') {
                        logTester.readLogs();
                    } else if (op.name === 'JSON変換') {
                        JSON.stringify(logTester.readLogs());
                    }
                }

                const endTime = performance.now();
                const totalTime = endTime - startTime;
                const avgTime = totalTime / op.count;

                results.push(`${op.name} (${op.count}回):`);
                results.push(`  総時間: ${totalTime.toFixed(2)}ms`);
                results.push(`  平均時間: ${avgTime.toFixed(3)}ms/回`);
                results.push('');
            });

            output.innerHTML = results.join('\n');
        }

        // ベンチマーク実行
        function benchmarkOperations() {
            const output = document.getElementById('performanceOutput');
            output.innerHTML = 'ベンチマーク実行中...\n';

            const testSizes = [10, 50, 100];
            let results = ['=== ベンチマーク結果 ===\n'];

            testSizes.forEach(size => {
                const startTime = performance.now();

                // 指定サイズのテストログを一気に生成
                for (let i = 0; i < size; i++) {
                    logTester.saveLog('benchmark', {
                        size: size,
                        index: i,
                        data: 'x'.repeat(100)
                    });
                }

                const endTime = performance.now();
                results.push(`${size}件処理: ${(endTime - startTime).toFixed(2)}ms`);
            });

            output.innerHTML = results.join('\n');
        }

        // ページ読み込み時の初期化
        window.addEventListener('load', () => {
            console.log('ログ機能テストページが読み込まれました');
            console.log('現在のログ数:', logTester.readLogs().length);
            console.log('セッションID:', logTester.sessionId);
        });
    </script>
</body>
</html>